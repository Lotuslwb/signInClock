<%- include("header.ejs",{"title": "结婚邀请函"}) %>
<link rel="stylesheet" href="/invitation/css/animate.css">

<div class="swiper-container template-container tpl1-container">
    <div class="swiper-wrapper">
        <div class="swiper-slide page tpl1-page page1">
            <div class="main">
                <div class="title">
                    <div class="title-en">
                        <img src="/invitation/img/text-title-en.png" alt="">
                    </div>
                    <div class="title-ch">婚礼邀请函</div>
                    <div class="title-text">一生一世一对人</div>
                </div>
                <div class="photo img-wrapper">
                    <img class="J-uploaded-img" data-tag="tmp1-pic1" src="" alt="photo">
                    <img class="photo-wrapper" src="/invitation/img/tpl1-photo-wrapper-1.png"
                         alt="">
                    <div class="upload-mask">
                        <input type="file">
                    </div>
                </div>
                <div class="info">
                    <div class="name">
                        <span><%= doc['templateForm']['groomName'] %></span>
                        <img src="/invitation/img/icon-and.png" alt="">
                        <span><%= doc['templateForm']['brideName'] %></span>
                    </div>
                    <div class="time"><%= doc['templateForm']['marriageTime'] %></div>
                    <div class="address"><%= doc['templateForm']['marriageAddress'] %></div>
                </div>
            </div>
        </div>
        <div class="swiper-slide page tpl1-page page2">
            <div class="main">
                <div class="photo img-wrapper">
                    <img class="J-uploaded-img" data-tag="tmp1-pic2" src="" alt="photo">
                    <img class="photo-wrapper" src="/invitation/img/tpl1-photo-wrapper-2.png" alt="">
                    <img class="ant-right-top" src="/invitation/img/tpl1-photo-wrapper-2-ani-right.png" alt="">
                    <img class="ani-left-bottom" src="/invitation/img/tpl1-photo-wrapper-2-ani-left.png" alt="">
                    <div class="upload-mask">
                        <input type="file">
                    </div>
                </div>
                <div class="info">
                    <div>从你为我戴上婚戒那一刻开始</div>
                    <div>“我”就变成了“我们”</div>
                </div>
            </div>
        </div>
        <div class="swiper-slide page tpl1-page page3">
            <img class="text" src="/invitation/img/tpl1-3-text.png" alt="">
            <div class="content">
                <div class="img-wrapper">
                    <img class="J-uploaded-img" data-tag="tmp1-pic3" src=""/>
                    <div class="upload-mask">
                        <input type="file">
                    </div>
                </div>
                <div class="img-wrapper">
                    <img class="J-uploaded-img" data-tag="tmp1-pic4" src=""/>
                    <div class="upload-mask">
                        <input type="file">
                    </div>
                </div>
            </div>
            <img class="ani-left-top" src="/invitation/img/tpl1-photo-wrapper-3-ani-left-top.png" alt="">
            <img class="ani-left-bottom" src="/invitation/img/tpl1-photo-wrapper-3-ani-left-bottom.png" alt="">
            <img class="ani-right-bottom" src="/invitation/img/tpl1-photo-wrapper-3-ani-right-bottom.png" alt="">
        </div>
        <div class="swiper-slide page tpl1-page page4">
            <img class="text" src="/invitation/img/tpl1-4-text.png" alt="">
            <div class="img-wrapper">
                <img class="J-uploaded-img" data-tag="tmp1-pic5" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <div class="img-wrapper">
                <img class="J-uploaded-img" data-tag="tmp1-pic6" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <img class="ani-left" src="/invitation/img/tpl1-photo-wrapper-4-ani-left.png" alt="">
            <img class="ani-right-top" src="/invitation/img/tpl1-photo-wrapper-4-ani-right-top.png" alt="">
        </div>
        <div class="swiper-slide page tpl1-page page5">
            <img class="text" src="/invitation/img/tpl1-5-text.png" alt="">
            <div class="img-wrapper img-top backgroundFFF">
                <img class="J-uploaded-img " data-tag="tmp1-pic7" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <div class="img-wrapper img-bottom">
                <img class="J-uploaded-img" data-tag="tmp1-pic8" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <img class="ani-right-bottom" src="/invitation/img/tpl1-photo-wrapper-5-ani-right-bottom.png" alt="">
        </div>
        <div class="swiper-slide page tpl1-page page6">
            <img class="text" src="/invitation/img/tpl1-6-text.png" alt="">
            <div class="img-wrapper img-top">
                <div class="img-bg"></div>
                <img class="J-uploaded-img" data-tag="tmp1-pic9" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <div class="img-wrapper img-bottom">
                <div class="img-bg"></div>
                <img class="J-uploaded-img" data-tag="tmp1-pic10" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <img class="ani-right-top" src="/invitation/img/tpl1-photo-wrapper-6-ani-right-top.png" alt="">
            <img class="ani-bottom" src="/invitation/img/tpl1-photo-wrapper-6-ani-bottom.png" alt="">
        </div>
        <div class="swiper-slide page  tpl1-page page7">
            <div class="mid">
                <div class="portrait">
                    <div class="img-wrapper">
                        <img class="J-uploaded-img" data-tag="tmp1-logo" src=""/>
                        <div class="upload-mask">
                            <input type="file">
                        </div>
                    </div>
                </div>
                <img class="text" src="/invitation/img/tpl1-7-text.png" alt="">
                <div class="map" id="map"></div>
                <div class="info">
                    <div class="time"><%= doc['templateForm']['marriageTime'] %></div>
                    <div class="address"><%= doc['templateForm']['marriageAddress'] %></div>
                </div>
            </div>
            <div class="btn-reply J-btn-reply">
                <img src="/invitation/img/tpl1-btn-reply.png" alt="">
            </div>
            <div class="modal J-reply-modal">
            </div>
        </div>
    </div>
</div>
<!--背景音乐 -->
<a href="javascript:; " class="u-globalAudio z-play">
    <i class="icon-music"></i>
</a>
<!--背景音乐 end-->

<!-- popup -->
<!--宾客回复-->
<div class="modal-form">
    <form class="J-form">
        <div class="input-wrapper">
            <label class="label" for="reply-modal-name">来宾姓名：</label>
            <input type="text" name="name" id="reply-modal-name" data-required="true" data-message="请输入来宾姓名"/>
        </div>
        <div class="input-wrapper">
            <div class="label">是否赴宴：</div>
            <div class="attend-wrapper">
                <label for="reply-modal-attend">
                    <input type="radio" name="isAttend" value="1" id="reply-modal-attend" checked/>赴宴
                </label>
                <label for="reply-modal-notattend">
                    <input type="radio" name="isAttend" value="0" id="reply-modal-notattend"/>待定
                </label>
            </div>
        </div>
        <div class="input-wrapper J-attend-wrapper">
            <div class="label">赴宴人数：</div>
            <div class="count-wrapper">
                <div class="btn-cnt-action J-minus">-</div>
                <div class="attend-cnt">1</div>
                <div class="btn-cnt-action J-plus">+</div>
            </div>
        </div>
        <div class="input-wrapper">
            <a class="btn J-submit-btn">确定</a>
        </div>
    </form>
</div>
<!--宾客回复 end-->
<!-- popup -->
<!--评论区域-->
<div class="blessing J-blessing">
    <div class="blessing-wrapper active">
        <img class="btn-close J-btn-close" src="/invitation/img/icon-close.png" alt="">
        <div class="live-blessing-wrapper">
            <ul class="live-blessing-list">
                <li>
                    <div><span>李文字彬：</span>啦啦啦</div>
                </li>
                <li>
                    <div><span class="myself">我：</span>哈哈哈</div>
                </li>
            </ul>
        </div>
        <div class="live-write">
            <input class="nickname" type="text" name="nickname" placeholder="昵称" data-required="true"
                   data-message="请输入昵称">
            <input class="blessing-info" type="text" name="blessing" placeholder="请留下最真挚的祝福..." data-required="true"
                   data-message="祝福不能为空哦~">
            <a href="javascript:;" class="btn-send J-btn-send">发送</a>
        </div>
    </div>
    <span class="send-bless">祝福</span>
</div>
<!--评论区域 end-->

<%- include("commonjs.ejs") %>
<script src="http://api.map.baidu.com/getscript?v=2.0&ak=2eed95cd0a38f5605d4b885b55211634&services=&t=20170511202040"></script>
<script src="/invitation/js/swiper-3.3.1.jquery.min.js"></script>
<script src="/invitation/js/lrz.all.bundle"></script>

<script>

    var id = "<%= doc['_id']; %>";
    var Info =<%- JSON.stringify(Info) %>;

    function Page() {
        this.init();
    }

    Page.prototype = {
        init: function () {
            this.initInfo();
            this.initMap();
            this.bindEvent();
            this.blessingEvent();
            this.replyEvent();
        },
        // 绑定事件
        bindEvent: function () {
            // 后退
            $('.J-back').click(function () {
                window.history.back();
            })

            // 制作请帖
            $('.J-btn-do').click(function () {
                window.location.href = 'index';
            })

            // 初始化swiper
            var mySwiper = new Swiper('.swiper-container', {
                direction: 'vertical',
            })
            // 背景音乐
            var music_key, once = 0;
            var audioElement = document.createElement('audio');
            audioElement.setAttribute('src', '/invitation/mp3/1.mp3');
            audioElement.controls = true;
            audioElement.loop = true;
            audioElement.autoplay = 'autoplay';
            audioElement.load();
            audioElement.play();

            var onTouchStart = function () {
                if (once == 0) {
                    once = 1;
                    audioElement.play();
                    music_key = 1;
                }
            }

            $(".u-globalAudio").on('touchstart', function () {
                if (music_key == 1) {
                    audioElement.pause();
                    music_key = 0;
                    $(this).addClass('z-pause').removeClass('z-play');
                } else {
                    audioElement.play();
                    music_key = 1;
                    $(this).addClass('z-play').removeClass('z-pause');
                }
                return false;
            });
            // 上传图片
            $('.upload-mask').change(function () {
                var $selector = $(this).find('input[type=file]');
                var $result = $(this).parents('.img-wrapper').find('.J-uploaded-img');
                window.mPZ.uploadImg($selector[0], $result[0]);
            })
        },
        initInfo: function () {
            $('.J-uploaded-img').each(function () {
                var tag = $(this).data('tag');
                $(this).attr('src', Info[tag] || '');
            })
        },
        initMap: function () {
            // 初始化地图
            var map = new BMap.Map("map");
            var point = new BMap.Point(112.991, 28.218);
            map.centerAndZoom(point, 16);
            // TODO 根据地址查（建议直接存经纬度，因为详细地址是地图上没有，比如房间号）
        },
        // 回复
        replyEvent: function () {
            var $formPopup = $('.modal-form');
            $('.J-btn-reply').click(function () {
                var mask = '<div class="modal J-reply-modal active"></div>';
                $formPopup.addClass('active');
                $('body').append(mask);
            })
            $('body').on('click', '.J-reply-modal', function () {
                $formPopup.removeClass('active');
                $('.J-reply-modal').remove();
            })
            $('input[type=radio]').change(function () {
                var type = $(this).val();
                if (type == '0') {
                    $('.J-attend-wrapper').css('display', 'none');
                } else {
                    $('.J-attend-wrapper').css('display', 'block');
                }
            })
            // 增加宾客数量
            $('.J-plus').click(function () {
                attendCountAction('add');
            })

            // 减少宾客数量
            $('.J-minus').click(function () {
                attendCountAction('minus');
            })

            function attendCountAction(action) {
                var step = 1;
                var $cnt = $('.attend-cnt');
                var origin = $cnt.text();
                origin = parseInt(origin);
                if (action == 'add') {
                    $cnt.text(origin + step);
                } else {
                    var newCnt = origin - step;
                    if (newCnt < 1) {
                        newCnt = 1;
                    }
                    $cnt.text(newCnt);
                }
            }

            // 提交用户填写的信息
            $('.J-submit-btn').click(function () {
                if (window.mPZ.checkForm($('.J-form'))) {
                    var name = $('input[name=name]').val();
                    var attendNumber = $('.attend-cnt').text();
                    var url = '';
                    var data = {};
                    // type==1代表赴宴，type==0代表待定
                    var type = $('input[name=isAttend]').val();
                    if (type == '1') {
                        url = '/invitation/api/setAttend';
                        data = {
                            _id: 'xxx',
                            attend: {
                                attendName: name, // 赴宴的名字
                                attendNumber: attendNumber, // 人数
                            }
                        }
                    } else {
                        url = '/invitation/api/setIndeterminate';
                        data = {
                            _id: 'xxx',
                            indeterminate: {
                                indeterminateName: name
                            }
                        }
                    }

                    $.ajax({
                        url: url,
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        beforeSend: function () {
                            // 禁用按钮防止重复提交
                            $('.J-submit-btn').attr({disabled: "disabled"});
                        },
                        success: function (res) {
                            $('.J-submit-btn').removeAttr("disabled");
                            $('.J-reply-modal').removeClass('active');
                            window.mPZ.toast('发送成功');
                        },
                        error: function (data) {
                            window.mPZ.toast("服务器正忙，请稍后再试");
                        }
                    })
                }
            });
        },
        // 祝福
        blessingEvent: function () {
            $('.J-btn-close').click(function () {
                $('.blessing-wrapper').removeClass('active');
                $('.send-bless').addClass('active');
            })
            $('.send-bless').click(function () {
                $('.send-bless').removeClass('active');
                $('.blessing-wrapper').addClass('active');
            })
            var i = 0;
            var startDo = null;
            var linum, lihei = 50 + 6;

            function toDo(text) {
                var theRQ = $('.live-blessing-list');
                if (theRQ.find('li').length < 3) {
                    return;
                }
                startDo = setInterval(function () {
                    linum = theRQ.find('li').length;
                    console.log('linum', linum);
                    if (i < linum - 2) {
                        $('.live-blessing-list').animate({'marginTop': -(i * lihei) + 'px'}, 500);
                        i++;
                    } else {
                        var firstLi = $('.live-blessing-list li').eq(0);
                        $('.live-blessing-list').append(firstLi.clone());
                        firstLi.remove();
                        i--;
                        $('.live-blessing-list').css({'marginTop': -(i * lihei + 10) + 'px'});
                        i++;
                        $('.live-blessing-list').animate({'marginTop': -(i * lihei + 10) + 'px'}, 500);
                    }
                    console.log(i)
                }, 3000);
            }

            toDo();
            $('.J-btn-send').on('click', function () {
                if (!window.mPZ.checkForm($('.live-write'))) {
                    return false;
                }
                var text = $('.live-write input[name=blessing]').val();
                var nickname = $('.live-write input[name=nickname]').val();
                var data = {
                    _id: id,
                    wish: {
                        wishName: nickname,
                        wishText: text,
                    }
                };
                $.ajax({
                    url: '/invitation/api/sendWish',
                    type: 'POST',
                    dataType: 'json',
                    data: data,
                    beforeSend: function () {
                        // 禁用按钮防止重复提交
                        $('.J-btn-send').attr({disabled: "disabled"});
                    },
                    success: function (res) {
                        if (data.status = 200) {
                            $('.J-btn-send').removeAttr("disabled");
                            $('.live-write input').val('');
                            clearInterval(startDo);
                            $('.live-blessing-list').append('<li><div><span class="myself">我：</span>' + text + '</div></li>');
                            if ($('.live-blessing-list li').length > 2) {
                                i++;
                                $('.live-blessing-list').animate({'marginTop': -(i * lihei) + 'px'}, 500);
                            }
                            toDo();
                        } else {
                            window.mPZ.toast(data.data);
                        }
                    },
                    error: function (data) {
                        window.mPZ.toast("服务器正忙，请稍后再试");
                    }
                })
            })
        }
    }
</script>
<script>
    new Page();
</script>


</body>
</html>