<%- include("header.ejs",{"title": "结婚邀请函"}) %>
<link rel="stylesheet" href="/invitation/css/animate.css">

<div class="swiper-container template-container tpl1-container">
    <div class="swiper-wrapper">
        <div class="swiper-slide page tpl1-page page1">
            <div class="main">
                <div class="title">
                    <div class="title-en">
                        <img src="/invitation/img/text-title-en.png" alt="">
                    </div>
                    <div class="title-ch">婚礼邀请函</div>
                    <div class="title-text">一生一世一对人</div>
                </div>
                <div class="photo">
                    <img class="J-uploaded-img" src="" alt="photo">
                    <img class="photo-wrapper" src="/invitation/img/tpl1-photo-wrapper-1.png" alt="">
                    <div class="upload-mask">
                        <input type="file">
                    </div>
                </div>
                <div class="info">
                    <div class="name">
                        <span><%= doc['templateForm']['groomName'] %></span>
                        <img src="/invitation/img/icon-and.png" alt="">
                        <span><%= doc['templateForm']['brideName'] %></span>
                    </div>
                    <div class="time"><%= doc['templateForm']['marriageTime'] %></div>
                    <div class="address"><%= doc['templateForm']['marriageAddress'] %></div>
                </div>
            </div>
        </div>
        <div class="swiper-slide page tpl1-page page2">
            <div class="main">
                <div class="photo">
                    <img class="J-uploaded-img" src="" alt="photo">
                    <img class="photo-wrapper" src="/invitation/img/tpl1-photo-wrapper-2.png" alt="">
                    <img class="ant-right-top" src="/invitation/img/tpl1-photo-wrapper-2-ani-right.png" alt="">
                    <img class="ani-left-bottom" src="/invitation/img/tpl1-photo-wrapper-2-ani-left.png" alt="">
                    <div class="upload-mask">
                        <input type="file">
                    </div>
                </div>
                <div class="info">
                    <div>从你为我戴上婚戒那一刻开始</div>
                    <div>“我”就变成了“我们”</div>
                </div>
            </div>
        </div>
        <div class="swiper-slide page tpl1-page page3">
            <img class="text" src="/invitation/img/tpl1-3-text.png" alt="">
            <div class="content">
                <div class="img-wrapper">
                    <img class="J-uploaded-img" src=""/>
                    <div class="upload-mask">
                        <input type="file">
                    </div>
                </div>
                <div class="img-wrapper">
                    <img class="J-uploaded-img"/>
                    <div class="upload-mask">
                        <input type="file">
                    </div>
                </div>
            </div>
            <img class="ani-left-top" src="/invitation/img/tpl1-photo-wrapper-3-ani-left-top.png" alt="">
            <img class="ani-left-bottom" src="/invitation/img/tpl1-photo-wrapper-3-ani-left-bottom.png" alt="">
            <img class="ani-right-bottom" src="/invitation/img/tpl1-photo-wrapper-3-ani-right-bottom.png" alt="">
        </div>
        <div class="swiper-slide page tpl1-page page4">
            <img class="text" src="/invitation/img/tpl1-4-text.png" alt="">
            <div class="img-wrapper">
                <img class="J-uploaded-img" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <div class="img-wrapper">
                <img class="J-uploaded-img"/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <img class="ani-left" src="/invitation/img/tpl1-photo-wrapper-4-ani-left.png" alt="">
            <img class="ani-right-top" src="/invitation/img/tpl1-photo-wrapper-4-ani-right-top.png" alt="">
        </div>
        <div class="swiper-slide page tpl1-page page5">
            <img class="text" src="/invitation/img/tpl1-5-text.png" alt="">
            <div class="img-wrapper img-top">
                <img class="J-uploaded-img" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <div class="img-wrapper img-bottom">
                <img class="J-uploaded-img" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <img class="ani-right-bottom" src="/invitation/img/tpl1-photo-wrapper-5-ani-right-bottom.png" alt="">
        </div>
        <div class="swiper-slide page tpl1-page page6">
            <img class="text" src="/invitation/img/tpl1-6-text.png" alt="">
            <div class="img-wrapper img-top">
                <div class="img-bg"></div>
                <img class="J-uploaded-img" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <div class="img-wrapper img-bottom">
                <div class="img-bg"></div>
                <img class="J-uploaded-img" src=""/>
                <div class="upload-mask">
                    <input type="file">
                </div>
            </div>
            <img class="ani-right-top" src="/invitation/img/tpl1-photo-wrapper-6-ani-right-top.png" alt="">
            <img class="ani-bottom" src="/invitation/img/tpl1-photo-wrapper-6-ani-bottom.png" alt="">
        </div>
        <div class="swiper-slide page  tpl1-page page7">
            <div class="mid">
                <div class="portrait">
                    <img src="img/cover.jpg">
                </div>
                <img class="text" src="/invitation/img/tpl1-7-text.png" alt="">
                <div class="map" id="map"></div>
                <div class="info">
                    <div class="time">2018年04月25日 14时33分</div>
                    <div class="address">台湾省台北市</div>
                </div>
            </div>
            <div class="bottom">
                <div class="item J-settings">
                    <img src="/invitation/img/icon-settings.png" alt="">
                    <span>设置</span>
                </div>
                <div class="item J-save">
                    <img src="/invitation/img/icon-save.png" alt="">
                    <span>保存</span>
                </div>
                <div class="item J-send">
                    <img src="/invitation/img/icon-send.png" alt="">
                    <span>发送</span>
                </div>
            </div>
            <div class="modal J-settings-modal">
                <div class="btn-groups">
                    <a href="javascript:;" class="btn primary-btn J-delete">删除请帖</a>
                    <a href="javascript:;" class="btn primary-btn J-remake">重新制作</a>
                    <a href="javascript:;" class="btn J-cancel">取消</a>
                </div>
            </div>
            <div class="modal J-send-modal">
                <div class="share-groups">
                    <div class="item">
                        <img src="/invitation/img/wechart.png" alt="">
                        <span>微信好友</span>
                    </div>
                    <div class="item">
                        <img src="/invitation/img/sina.png" alt="">
                        <span>新浪微博</span>
                    </div>
                    <div class="item">
                        <img src="/invitation/img/qq-zone.png" alt="">
                        <span>QQ空间</span>
                    </div>
                    <div class="item">
                        <img src="/invitation/img/douban.png" alt="">
                        <span>豆瓣</span>
                    </div>
                </div>
                <div class="btn-wrapper">
                    <img class="btn-cancel J-btn-cancel" src="/invitation/img/icon-close.png" alt="">
                </div>
            </div>
        </div>
    </div>
</div>
<!--背景音乐 -->
<a href="javascript:; " class="u-globalAudio z-play">
    <i class="icon-music"></i>
</a>
<!--背景音乐 end-->

<%- include("commonjs.ejs") %>
<script src="http://api.map.baidu.com/getscript?v=2.0&ak=2eed95cd0a38f5605d4b885b55211634&services=&t=20170511202040"></script>
<script src="/invitation/js/swiper-3.3.1.jquery.min.js"></script>
<script src="/invitation/js/lrz.all.bundle"></script>

<script>
    function Page() {
        this.init();
    }

    Page.prototype = {
        init: function () {
            this.initMap();
            this.bindEvent();
            this.settingsEvent();
            this.shareEvent();
            this.saveEvent();
        },
        // 绑定事件
        bindEvent: function () {
            // 后退
            $('.J-back').click(function () {
                window.history.back();
            })
            // 初始化swiper
            var mySwiper = new Swiper('.swiper-container', {
                direction: 'vertical',
            })
            // 背景音乐
            var music_key, once = 0;
            var audioElement = document.createElement('audio');
            audioElement.setAttribute('src', '/invitation/mp3/1.mp3');
            audioElement.controls = true;
            audioElement.loop = true;
            audioElement.autoplay = 'autoplay';
            audioElement.load();
            audioElement.play();

            var onTouchStart = function () {
                if (once == 0) {
                    once = 1;
                    audioElement.play();
                    music_key = 1;
                }
            }

            $(".u-globalAudio").on('touchstart', function () {
                if (music_key == 1) {
                    audioElement.pause();
                    music_key = 0;
                    $(this).addClass('z-pause').removeClass('z-play');
                } else {
                    audioElement.play();
                    music_key = 1;
                    $(this).addClass('z-play').removeClass('z-pause');
                }
                return false;
            });
            // 上传图片
            $('.upload-mask').change(function () {
                var $selector = $(this).find('input[type=file]')[0];
                var $result = $(this).parents('.photo').find('.J-uploaded-img')[0];
                window.mPZ.uploadImg($selector, $result);
            })

            // $.ajax({
            //     type: 'POST',
            //     url: '/invitation/api/addInvitation',
            //     data: {
            //         templateId: '1',
            //         ownerId: 'openId1212', // 归属人的OPENID
            //         ownerName: '李文字彬', // 归属人的nickname
            //     },
            //     success: function (data) {
            //         console.log(data);
            //         postData(data.data._id);
            //     },
            //     dataType: 'json'
            // });
            postData('5af5511e34e60926e93addcc');

            // 提交用户填写的信息
            function postData(id) {
                $('.J-submit-btn').click(function () {
                    if (window.mPZ.checkForm($('.form'))) {
                        var groomName = $('input[name=groomName]').val();
                        var brideName = $('input[name=brideName]').val();
                        var marriageTime = $('input[name=marriageTime]').val();
                        var address = $('input[name=address]').val();
                        var addressDetail = $('input[name=addressDetail]').val() || '';
                        var marriageAddress = address + addressDetail;
                        var data = {
                            _id: id,
                            templateForm: {
                                groomName: groomName,
                                brideName: brideName,
                                marriageTime: marriageTime,
                                marriageAddress: marriageAddress
                            }
                        }
                        $.ajax({
                            url: '/invitation/api/updateInvitationForm',
                            type: 'POST',
                            dataType: 'json',
                            data: data,
                            beforeSend: function () {
                                // 禁用按钮防止重复提交
                                $('.J-submit-btn').attr({disabled: "disabled"});
                            },
                            success: function (res) {
                                $('.J-submit-btn').removeAttr("disabled");
                                window.mPZ.toast('提交成功');
                                setTimeout(function () {
                                    window.location.href = './template1.html';
                                }, 1000);
                            },
                            error: function (data) {
                                window.mPZ.toast("服务器正忙，请稍后再试");
                            }
                        })
                    }
                });
            }
        },
        initMap: function () {
            // 初始化地图
            var map = new BMap.Map("map");
            var point = new BMap.Point(112.991, 28.218);
            map.centerAndZoom(point, 16);
            // TODO 根据地址查（建议直接存经纬度，因为详细地址是地图上没有，比如房间号）
        },
        // 设置
        settingsEvent: function () {
            $('.J-settings').click(function () {
                $('.J-settings-modal').addClass('active');
            })
            $('.J-delete').click(function () {
                // TODO 删除请帖
            })
            $('.J-remake').click(function () {
                // TODO 重新制作，先调用删除的接口，再跳转到选择模板的页面
            })
            $('.J-settings-modal .J-cancel').click(function () {
                $('.J-settings-modal').removeClass('active');
            })
        },
        // 分享
        shareEvent: function () {
            $('.J-send').click(function () {
                $('.J-send-modal').addClass('active');
                // TODO 分享
            });
            $('.J-send-modal .J-btn-cancel').click(function () {
                $('.J-send-modal').removeClass('active');
            })
        },
        // 保存
        saveEvent: function () {
            $('.J-save').click(function () {
                // TODO 保存。需要把每个图片的id拿到，与对应的templateId一起传送
            })
        }
    }
</script>
<script>
    new Page();
</script>


</body>
</html>