<%- include("header.ejs",{"title":'打卡'}) %>

<div class="page main-page reading-page active">
    <div class="reading-title"><%= bookInfo.articleTitle %></div>
    <div class="reading-video">
        <% if(bookInfo.videoURL){ %>
        <% var videoStrArry = bookInfo.videoURL.split('/'); var videoCode = videoStrArry[videoStrArry.length - 1].split('.html')[0]; %>
        <iframe frameborder="0" class="iframe"
                src="https://v.qq.com/iframe/player.html?vid=<%= videoCode %>&tiny=0&auto=0">
        </iframe>
        <% } %>
    </div>
    <div class="reading-main">
        <%- bookInfo.articleText %>
    </div>
    <div class="record-btn-list">
        <div class="record-btn btn-item">
            <div class="J-record-btn game_time">
                <div class="hold">
                    <div class="pie pie1"></div>
                </div>
                <div class="hold">
                    <div class="pie pie2"></div>
                </div>
                <div class="bg"></div>
                <div class="time"><img src="../../../../daka/img/record-icon.png" class="record-icon"></div>
            </div>
            <div class="record-status J-record-status">点击录制</div>
        </div>

        <div class="againRecord-btn btn-item btn-item2">
            <img src="../../../../daka/img/againRecord.png" class="record-icon J-againRecord-btn">
            <div class="record-status">重录</div>
        </div>
        <div class="playRecord-btn btn-item btn-item2">
            <div class="J-playRecord-btn game_time">
                <div class="hold">
                    <div class="pie pie1"></div>
                </div>
                <div class="hold">
                    <div class="pie pie2"></div>
                </div>
                <div class="bg"></div>
                <div class="time"><img src="/daka/img/playRecord.png" class="record-icon"></div>
            </div>
            <div class="record-status J-playRecord-text">回放</div>
        </div>
        <div class="gotoDaka-btn btn-item btn-item2">
            <img src="../../../../daka/img/gotoDaka.png" class="record-icon J-gotoDaka-btn">
            <div class="record-status">去打卡</div>
        </div>
    </div>

    <!--<div class="banner">-->
    <!--<img src="../../../../daka/img/pic-banner.jpg">-->
    <!--</div>-->
</div>


<%- include("menu.ejs",{"type":''}) %>
<%- include("commonjs.ejs") %>
<script>

    var bookId = '<%= bookInfo._id %>';
    var bookName = '<%= bookInfo.articleTitle %>';
    var bookCover = '<%= bookInfo.coverUrl %>';
    var bookDes = '<%= bookInfo.brief %>';
    var wordLength = '<%= bookInfo.wordLength %>';
    var localId = '';

    var preScrollTop = 0;

    var $iframe = $('.iframe');
    $('.reading-page').scroll(function () {
        var top = $(this).scrollTop();
        var diff = Math.abs(top - preScrollTop);
        preScrollTop = top;
        if (diff < 5) {
            return false;
        }

        top > 100 ? $iframe.addClass('active') : $iframe.removeClass('active');
    });

    function recordStop(res) {
        localId = res.localId;
        $('.record-btn-list').addClass('active');
        countStop();
    }

    initWX(function () {
        initWXSahre();

        //开始录音 或者结束录音
        $('.J-record-btn').click(function () {
            if ($(this).hasClass('active')) {
                $(this).removeClass('active');
                //已经在录音,结束录音
                wx.stopRecord({
                    success: function (res) {
                        recordStop(res);
                    }
                });
            } else {
                wx.startRecord();
                $(this).addClass('active');
                $('.J-record-status').html('录音中...<span class="J-time"></span>');
                countDown();
            }
        })

        //播放录音
        $('.J-playRecord-btn').click(function () {
            if ($(this).hasClass('active')) {
                $(this).removeClass('active');
                wx.stopRecord({
                    success: function (res) {
                        $('.J-playRecord-text').text('回放');
                    }
                });
            } else {
                $(this).addClass('active');
                if (localId) {
                    wx.playVoice({
                        localId: localId // 需要播放的音频的本地ID，由stopRecord接口获得
                    });
                    $('.J-playRecord-text').html('回放中<span class="dotting"></span>');
                } else {
                    alert('没有录音');
                }
            }
        });

        //重新录音
        $('.J-againRecord-btn').click(function () {
            $('.record-btn-list').removeClass('active');
            $('.J-record-status').text('点击录音');
        })

        $('.J-gotoDaka-btn').click(function () {
            // 上传音频 和 打卡
            wx.uploadVoice({
                localId: localId, // 需要上传的音频的本地ID，由stopRecord接口获得
                isShowProgressTips: 1, // 默认为1，显示进度提示
                success: function (res) {
                    var serverId = res.serverId; // 返回音频的服务器端ID
                    console.log(serverId);
                    setSignIn({
                        serverId: serverId,
                        bookDes: bookDes,
                        bookId: bookId,
                        bookName: bookName,
                        bookCover: bookCover,
                        wordLength: wordLength
                    }, function (data) {
                        console.log(data);
                        showAlert({
                            title: "打卡成功",
                            text: "你的录音已经保存成功啦！非常赞！明天也要继续努力哟，连续打卡21天，有机会赢取英孚青少儿英语校内营1周课程或语言运用俱乐部活动哟，千万不要错过啦！",
                            callback: function () {
                                window.location.href = '/daka/result?bookId=' + bookId;
                            }
                        });
                    })

                }
            });
        })

        wx.onVoiceRecordEnd({
            // 录音时间超过一分钟没有停止的时候会执行 complete 回调
            complete: function (res) {
                recordStop(res);
            }
        });
        wx.onVoicePlayEnd({
            success: function (res) {
                $('.J-playRecord-text').text('回放');
            }
        });
    });

    function setSignIn(data, cb) {
        $.ajax({
            type: 'GET',
            data: data,
            url: '/dakaApi/setSignIn',
            success: function (data) {
                console.log(data);
                if (data.status == '200') {
                    cb && cb(data);
                } else {
                    alert(data.errmsg);
                }
            },
            dataType: 'json'
        });
    }


</script>
<script>
    var i = 0;
    var j = 0;
    var count = 0;
    var MM = 0;
    var SS = 60;  // 秒 90s
    var MS = 0;
    var totle = (MM + 1) * 600;
    var d = 180 * (MM + 1);
    var MM = "0" + MM;
    var gameTime = 60;
    var showTime = function () {
        totle = totle - 1;
        if (totle == 0) {
            clearInterval(s);
            clearInterval(t1);
            $(".pie2").css("-webkit-transform", "rotate(0deg)");
            $(".pie1").css("-webkit-transform", "rotate(" + d + "deg)");
            overTime();
        } else {
            if (totle > 0 && MS > 0) {
                MS = MS - 1;
                if (MS < 10) {
                    MS = "0" + MS
                }

            }

            if (MS == 0 && SS > 0) {
                MS = 10;
                SS = SS - 1;
                if (SS < 10) {
                    SS = "0" + SS
                }
            }
            if (SS == 0 && MM > 0) {
                SS = 60;
                MM = MM - 1;
                if (MM < 10) {
                    MM = "0" + MM
                }
            }
        }
        $(".J-time").html(60 - SS * 1 + "s");
    };

    var start1 = function () {
        //i = i + 0.6;
        i = i + 360 / ((gameTime) * 10);  //旋转的角度  90s 为 0.4  60s为0.6
        count = count + 1;
        if (count <= (gameTime / 2 * 10)) {  // 一半的角度  90s 为 450
            $(".pie1").css("-o-transform", "rotate(" + i + "deg)");
            $(".pie1").css("-moz-transform", "rotate(" + i + "deg)");
            $(".pie1").css("-webkit-transform", "rotate(" + i + "deg)");
        } else {
            $(".pie2").css("backgroundColor", "#0068b1");
            $(".pie2").css("-o-transform", "rotate(" + i + "deg)");
            $(".pie2").css("-moz-transform", "rotate(" + i + "deg)");
            $(".pie2").css("-webkit-transform", "rotate(" + i + "deg)");
        }
    };

    showTime();

    var countDown = function () {
        //80*80px 时间进度条
        i = 0;
        j = 0;
        count = 0;
        MM = 0;
        SS = gameTime;
        MS = 0;
        totle = (MM + 1) * gameTime * 10;
        d = 180 * (MM + 1);
        MM = "0" + MM;

        showTime();

        s = setInterval("showTime()", 100);
        start1();
        t1 = setInterval("start1()", 100);
    }

    var countStop = function () {
        clearInterval(s);
        clearInterval(t1);
        $(".pie1").css("-webkit-transform", "rotate(0deg)");
        $(".pie2").css("-webkit-transform", "rotate(0deg)");
    }

    var overTime = function () {
        console.log('计时器结束');
    }
</script>
</body>
</html>