<%- include("header.ejs",{"title":'英孚亲子共读训练营'}) %>

<div id="number-tpl" class="number-tpl">
    <span class="number-text">0<br/>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9</span></div>

<div class="page main-page index-page result-page active">

    <div class="index-words">
        <div class="banner-text">
            <img src="/daka/img/EF.png" class="banner-logo"/>
            <div class="banner-title">
                我和宝贝的亲子共读计划
                <div class="banner-info"><span class="J-startDate"></span> 开始</div>
            </div>
        </div>
        <div class="personal-info">
            <img src="http://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLyV1Ir9mstNAOmvyNzpTFcibv3xWVSCp135dehaicLbhWY6hRDnadIibZYEr31bE2y3Egt0HU60ibKdw/0"
                 class="personal-logo">
            <div class="personal-name J-nickname"></div>
        </div>
        <div class="record-info">
            <div class="record-info-left">
                <div class="title">累积阅读时间</div>
                <div class="text">
                    <div class="animate-number J-currentRecodeCounts"></div>
                    <span class="days">天</span></div>
            </div>
            <div class="record-info-right">
                <div class="title">累积阅读字数</div>
                <div class="text J-totalWordLength animate-number"></div>
            </div>
            <div class="record-info-mid"></div>
            <div class="hr"></div>
        </div>
        <div class="book-info">
            <div class="title">听听他今天读了什么</div>
            <img class="cover" src="<%= bookInfo.coverUrl %>"/>
            <div class="main">
                <div class="medie-player">
                    <img src="/daka/img/media-player-icon.jpg" class="media-player-icon">
                    <div class="articleTitle">
                        <%= bookInfo.articleTitle %>
                        <span>来自EF英孚教育青少儿英语</span>
                    </div>
                </div>
                <div class="text"><%= bookInfo.brief %></div>
            </div>
        </div>
    </div>
    <div class="AD-info">
        <img src="/daka/img/qcode.png" class="qcode">
    </div>
    <div class="overlay overlay-share">
        <img src="/daka/img/shareTxt.png" class="shareTxt">
    </div>
</div>

<%- include("commonjs.ejs") %>
<script>


    <%
    var currentReadingInfo = UserInfo.readingInfo.filter(function (item) {
        item['_id'] = [];
        return item.readingTimeId == readTime;
    })[0];
    %>


    var bookId = "<%= bookInfo._id %>";
    var readTime = <%- readTime %>;

    var recordLocalId = "<%= currentReadingInfo['recordLocalId'] %>", recordServerId = "<%= currentReadingInfo['recordServerId'] %>";
    var localId;

    $('.share-btn').click(function () {
        $('.overlay-share').show();
    });

    $('.overlay-share').click(function () {
        $(this).hide();
    })


    var userId = '<%= UserInfo._id %>';
    var personInfo = <%- UserInfo.personInfo %>;
    var recodeInfo = <%- UserInfo.recodeInfo %>;
    var firstDay = '<%= UserInfo.readingInfo[0].readingTimeId %>';


    var headimgurl = personInfo ? personInfo['headimgurl'] : '';
    var nickname = personInfo ? personInfo['nickname'] : '';
    var currentRecodeCounts = recodeInfo ? recodeInfo['currentRecodeCounts'] || 0 : 0;
    var totalWordLength = recodeInfo ? recodeInfo['totalWordLength'] || 0 : 0;
    $('.J-nickname').text(nickname)
    $('.personal-logo').attr('src', headimgurl);

    $('.J-startDate').text(firstDay.substr(0, 4) + '/' + firstDay.substr(4, 2) + '/' + firstDay.substr(6, 2));

    initAnimateNumber();

    function initAnimateNumber() {
        var $tpl = $('#number-tpl');
        var $currentRecodeCounts = $('.J-currentRecodeCounts');
        var $totalWordLength = $('.J-totalWordLength');

        for (var i = 0; i < currentRecodeCounts.length; i++) {
            var $tpl_new = $tpl.clone().find('span');
            $currentRecodeCounts.append($tpl_new);
        }

        for (var i = 0; i < totalWordLength.length; i++) {
            var $tpl_new = $tpl.clone().find('span')
            $totalWordLength.append($tpl_new);
        }

        setTimeout(function () {
            for (var i = 0; i < currentRecodeCounts.length; i++) {
                var translateStr = 'translate3d(0,' + -1 * 66 * currentRecodeCounts[i] + 'px,0)';
                $currentRecodeCounts.find('.number-text').eq(i).css({
                    'transform': translateStr,
                    'webkitTransform': translateStr
                });
                console.log(currentRecodeCounts, 'currentRecodeCounts');
            }

            for (var i = 0; i < totalWordLength.length; i++) {
                var translateStr = 'translate3d(0,' + -1 * 66 * totalWordLength[i] + 'px,0)';
                $totalWordLength.find('.number-text').eq(i).css({
                    'transform': translateStr,
                    'webkitTransform': translateStr
                });
                console.log(totalWordLength, 'totalWordLength');

            }
        }, 200)
    }

    initWX(function () {
        WXDownloadVoice();

        $('.medie-player').click(function () {
            if (localId) {
                console.log(localId);
                wx.playVoice({
                    localId: localId // 需要播放的音频的本地ID，由stopRecord接口获得
                });
            } else {
                WXDownloadVoice(function (localId) {
                    wx.playVoice({
                        localId: localId // 需要播放的音频的本地ID，由stopRecord接口获得
                    });
                })
            }
        });

        //“分享给朋友”
        wx.onMenuShareAppMessage({
            title: nickname + '正在读【'+"<%- bookInfo.articleTitle %>"+'】', // 分享标题
            desc: 'TA已经坚持亲子阅读' + currentRecodeCounts + '天，读了' + totalWordLength + '字，keep moving~', // 分享描述
            link: 'http://ma.eldesign.cn/daka/share?bookId=' + bookId + '&userId=' + userId + '&readTime=' + readTime, // 分享链接
            imgUrl: 'http://ma.eldesign.cn/daka/img/sharelogo.jpg', // 分享图标
            type: '', // 分享类型,music、video或link，不填默认为link
            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            success: function () {
                // 用户确认分享后执行的回调函数
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });

        //“分享到朋友圈”
        wx.onMenuShareTimeline({
            title: nickname + '正在读'+"<%- bookInfo.articleTitle %>"+'，已经坚持亲子阅读' + currentRecodeCounts + '天，读了' + totalWordLength + '字，keep moving~', // 分享标题
            link: 'http://ma.eldesign.cn/daka/share?bookId=' + bookId + '&userId=' + userId + '&readTime=' + readTime, // 分享链接
            imgUrl: 'http://ma.eldesign.cn/daka/img/sharelogo.jpg', // 分享图标
            success: function () {
                // 用户确认分享后执行的回调函数
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });

    })

    function WXDownloadVoice(cb) {
        wx.downloadVoice({
            serverId: recordServerId, // 需要下载的音频的服务器端ID，由uploadVoice接口获得
            isShowProgressTips: 1, // 默认为1，显示进度提示
            success: function (res) {
                localId = res.localId; // 返回音频的本地ID
                console.log(res);
                //alert('下载音频成功' + JSON.stringify(res));
                cb && cb(localId);
            },
            fail: function (res) {
                alert('下载音频失败:' + JSON.stringify(res));
            },
            complete: function (res) {
                //alert('complete:' + JSON.stringify(res));
            }
        });
    }
</script>

</body>
</html>