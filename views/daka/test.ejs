<%- include("../header.ejs",{"title":'微信JS-SDK 测试'}) %>


<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="/javascripts/jquery.js"></script>
<script src="/javascripts/api.js"></script>
<script>
    $.ajax({
        type: 'GET',
        url: '/api/getUseInfo',
        data: {},
        success: function (data) {
            console.log(data);

            if (data.status == '200') {
                var persionInfo = data.data[0].personInfo;
                $('.Tpl-nickname').text(persionInfo.nickname);
                $('.Tpl-sex').text(persionInfo.sex);
                $('.Tpl-headimgurl').attr('src', persionInfo.headimgurl);

                var recodeInfo = data.data[0].recodeInfo;
                var lastTimeDate = recodeInfo.lastRecodeTime ? new Date(recodeInfo.lastRecodeTime * 1) : '';
                $('.Tpl-currentRecodeCounts').text(recodeInfo.currentRecodeCounts || 0);
                $('.Tpl-currentSerialRecodeCounts').text(recodeInfo.currentSerialRecodeCounts || 0);
                $('.Tpl-totalRecodeCounts').text(recodeInfo.totalRecodeCounts || 0);


                if (lastTimeDate) {
                    $('.Tpl-lastRecodeTime').text(window.oo.dateFormat(lastTimeDate));
                    if (isToday(lastTimeDate)) {
                        $('.J-singIn').addClass('weui_btn_disabled');
                    }
                }


            } else {
                alert(data.errmsg);
            }
        },
        dataType: 'json'
    });

    $('.J-singIn').click(function () {
        if ($(this).hasClass('weui_btn_disabled')) {
            return false;
        }

        $.ajax({
            type: 'GET',
            url: '/api/setSignIn',
            data: {},
            success: function (data) {
                console.log(data);

                if (data.status == '200') {
                    alert('打卡成功');
                    window.location.reload();
                } else {
                    alert(data.errmsg);
                }
            },
            dataType: 'json'
        });
    });

    window.oo.initWX(function () {
        window.oo.initWXSahre();
    });


    function isToday(date) {
        var now = new Date();

        if (now.getYear() == date.getYear() && now.getMonth() == date.getMonth() && now.getDate() == date.getDate()) {
            return true;
        } else {
            return false;
        }
    }
</script>
</body>
</html>
